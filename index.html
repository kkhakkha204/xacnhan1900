<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mona+Sans:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>1900 Hair Salon - Kiosk</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: "Mona Sans", sans-serif;
            background: linear-gradient(135deg, #003F2F 0%, #000D0A 100%);
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
            background-color: #000; /* kh·ªõp theme */
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Waiting screen - Simple logo only */
        .waiting-screen {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .waiting-screen.hidden {
            display: none;
        }

        .logo {
            width: 400px;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logoqr {
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* QR screen - Simple QR + Timer only */
        .qr-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .qr-screen.active {
            display: flex;
        }

        .qr-container {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
        }

        .qr-code {
            width: 250px;
            height: 250px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            overflow: hidden;
        }

        .qr-code img {
            max-width: 100%;
            max-height: 100%;
        }

        .timer-container {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .timer {
            font-size: 24px;
            color: #ffffff;
        }

        .qr-instruction {
            color: white;
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .customer-name {
            color: white;
            font-size: 18px;
            font-weight: 500;
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Waiting screen - Logo only -->
    <div class="waiting-screen" id="waitingScreen">
        <div class="logo">
            <img src="a.png" alt="1900 Hair Salon" style="width: 100%; height: 100%; object-fit: contain;">
        </div>
    </div>

    <!-- QR screen - QR + Timer only -->
    <div class="qr-screen" id="qrScreen">
        <div class="logoqr">
            <img src="a.png" alt="1900 Hair Salon" style="width: 100%; height: 100%; object-fit: contain;">
        </div>

        <div class="qr-instruction">
            Vui l√≤ng qu√©t m√£ QR
        </div>

        <div class="qr-container">
            <div class="qr-code" id="qrCode">
                ƒêang t·∫°o m√£ QR...
            </div>
        </div>

        <div class="customer-name" id="customerName">
            <!-- T√™n kh√°ch h√†ng s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </div>

        <div class="timer-container">
            <span class="timer" id="timer">03:00</span>
        </div>
    </div>
</div>

<script>
    // CONFIGURATION
    const NOCODB_CONFIG = {
        baseUrl: 'https://data.nextgency.vn',
        apiToken: 'zYAx_j_2heVC-nikJ4tZiB_NwMnuKR61dxAczZBy', // THAY ƒê·ªîI TOKEN
        baseId: 'porgm26ubel7371',
        tableId: 'm0azbw50puhet36'
    };

    // External detail page URL
    const DETAIL_PAGE_BASE_URL = 'https://nghecontent.eventhub.vn/xacnhan';

    // NOCODB API CLASS
    class NocoDBAPI {
        constructor(config) {
            this.baseUrl = config.baseUrl;
            this.apiToken = config.apiToken;
            this.baseId = config.baseId;
            this.tableId = config.tableId;
            this.apiEndpoint = `${this.baseUrl}/api/v1/db/data/noco/${this.baseId}/${this.tableId}`;
        }

        getHeaders() {
            return {
                'Content-Type': 'application/json',
                'xc-token': this.apiToken
            };
        }

        async getNewRecords() {
            try {
                const url = `${this.apiEndpoint}?where=(status,eq,NEW)&sort=-submit_time`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: this.getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching new records:', error);
                throw error;
            }
        }

        async updateOrderStatus(orderId, status) {
            try {
                // Find record first
                const orderUrl = `${this.apiEndpoint}?where=(order_ID,eq,${orderId})`;
                const response = await fetch(orderUrl, {
                    method: 'GET',
                    headers: this.getHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const order = data.list && data.list.length > 0 ? data.list[0] : null;

                if (!order) {
                    throw new Error('ƒê∆°n h√†ng kh√¥ng t·ªìn t·∫°i');
                }

                // Find ID field
                const recordId = order.Id || order.id || order._id || order.ID;
                if (!recordId) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y ID c·ªßa ƒë∆°n h√†ng');
                }

                // Update status
                const updateUrl = `${this.apiEndpoint}/${recordId}`;
                const updateResponse = await fetch(updateUrl, {
                    method: 'PATCH',
                    headers: this.getHeaders(),
                    body: JSON.stringify({ status: status })
                });

                if (!updateResponse.ok) {
                    const errorText = await updateResponse.text();
                    throw new Error(`L·ªói c·∫≠p nh·∫≠t: ${updateResponse.status} - ${errorText}`);
                }

                return await updateResponse.json();
            } catch (error) {
                console.error('Error updating order:', error);
                throw error;
            }
        }
    }

    // GLOBAL VARIABLES
    const nocoAPI = new NocoDBAPI(NOCODB_CONFIG);

    // Kiosk state
    let kioskState = 'waiting';
    let currentOrder = null;
    let qrTimer = null;
    let pollingInterval = null;
    let timeLeft = 180;

    // UTILITY FUNCTIONS
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // KIOSK FUNCTIONS
    function generateQRCode(orderId) {
        const qrUrl = `${DETAIL_PAGE_BASE_URL}?orderId=${orderId}`;
        const qrCodeElement = document.getElementById('qrCode');

        try {
            qrCodeElement.innerHTML = 'ƒêang t·∫°o m√£ QR...';

            const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=350x350&data=${encodeURIComponent(qrUrl)}&ecc=M`;

            const img = document.createElement('img');
            img.src = qrImageUrl;
            img.alt = 'QR Code';
            img.style.width = '100%';
            img.style.height = '100%';

            img.onload = () => {
                qrCodeElement.innerHTML = '';
                qrCodeElement.appendChild(img);
                console.log('‚úÖ QR Code generated for:', qrUrl);
            };

            img.onerror = () => {
                qrCodeElement.innerHTML = `
                    <div style="text-align: center; color: #ff4444; padding: 20px;">
                        <div style="font-size: 24px;">üì±</div>
                        <div>Qu√©t link: ${qrUrl}</div>
                    </div>
                `;
            };

        } catch (error) {
            console.error('‚ùå Error generating QR code:', error);
        }
    }

    function showWaitingScreen() {
        kioskState = 'waiting';
        document.getElementById('waitingScreen').classList.remove('hidden');
        document.getElementById('qrScreen').classList.remove('active');
    }

    function showQRScreen(order) {
        kioskState = 'displaying_qr';
        currentOrder = order;
        timeLeft = 180;

        document.getElementById('waitingScreen').classList.add('hidden');
        document.getElementById('qrScreen').classList.add('active');

        // TH√äM PH·∫¶N N√ÄY - Hi·ªÉn th·ªã t√™n kh√°ch h√†ng
        const customerNameElement = document.getElementById('customerName');
        const prefix = 'Kh√°ch h√†ng';
        const customerName = order.name || 'Kh√°ch h√†ng';
        customerNameElement.textContent = `${prefix} ${customerName}`;

        generateQRCode(order.order_ID);
        startTimer();
    }

    function startTimer() {
        if (qrTimer) clearInterval(qrTimer);

        qrTimer = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').textContent = formatTime(timeLeft);

            if (timeLeft <= 0) {
                clearInterval(qrTimer);
                qrTimer = null;
                finishCurrentOrder();
            }
        }, 1000);
    }

    async function finishCurrentOrder() {
        if (!currentOrder) {
            showWaitingScreen();
            return;
        }

        try {
            await nocoAPI.updateOrderStatus(currentOrder.order_ID, 'DONE');
            console.log(`‚úÖ Updated order ${currentOrder.order_ID} to DONE`);
        } catch (error) {
            console.error('‚ùå Error finishing order:', error);
        } finally {
            currentOrder = null;
            if (qrTimer) {
                clearInterval(qrTimer);
                qrTimer = null;
            }
            showWaitingScreen();
        }
    }

    async function pollForNewRecords() {
        try {
            const result = await nocoAPI.getNewRecords();
            const newRecords = result.list || [];

            // Check if current order still exists and is NEW
            if (kioskState === 'displaying_qr' && currentOrder) {
                const currentOrderStillNew = newRecords.find(record =>
                    record.order_ID === currentOrder.order_ID
                );

                if (!currentOrderStillNew) {
                    // Current order is no longer NEW (was confirmed), go back to waiting
                    console.log(`üì± Order ${currentOrder.order_ID} was confirmed, returning to waiting screen`);
                    currentOrder = null;
                    if (qrTimer) {
                        clearInterval(qrTimer);
                        qrTimer = null;
                    }
                    showWaitingScreen();
                    return;
                }
            }

            // Check for new orders when waiting
            if (kioskState === 'waiting' && newRecords.length > 0) {
                const latestOrder = newRecords[0];
                showQRScreen(latestOrder);
            }
        } catch (error) {
            console.error('Polling error:', error);
        }
    }

    function initializeKiosk() {
        console.log('üöÄ Initializing Kiosk...');
        showWaitingScreen();

        // Poll more frequently (every 2 seconds) to detect confirmations faster
        pollingInterval = setInterval(pollForNewRecords, 2000);
        pollForNewRecords();

        console.log('‚úÖ Kiosk initialized with 2s polling');
    }

    // CLEANUP
    function cleanup() {
        if (pollingInterval) clearInterval(pollingInterval);
        if (qrTimer) clearInterval(qrTimer);
    }

    // EVENT LISTENERS
    window.addEventListener('load', initializeKiosk);
    window.addEventListener('beforeunload', cleanup);

    // DEBUG FUNCTIONS
    window.appDebug = {
        // Kiosk debug
        showQR: (orderId) => {
            const testOrder = {
                order_ID: orderId || 'TEST123',
                name: 'Test Customer',
                'product/service': 'C·∫Øt t√≥c',
                money: 100000
            };
            showQRScreen(testOrder);
        },
        showWaiting: showWaitingScreen,
        pollKiosk: pollForNewRecords,
        finishOrder: finishCurrentOrder,
        testTimer: () => {
            if (currentOrder) {
                timeLeft = 10;
                console.log('Timer set to 10 seconds for testing');
            }
        },
        getState: () => ({
            kioskState,
            currentOrder,
            timeLeft
        }),
        generateTestQR: (orderId) => {
            generateQRCode(orderId || 'TEST123');
        }
    };
</script>
</body>
</html>